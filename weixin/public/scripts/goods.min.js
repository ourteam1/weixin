var GoodsApp=$.extend({init:function(){this.Goods.render()}},App||{});GoodsApp.total_cart_goods_num=function(){var a=0;$.each(goods_data,function(c,b){a+=b.cart_num||0});return a};GoodsApp.total_cart_goods_price=function(){var a=0;$.each(goods_data,function(c,b){a+=b.discount>0?b.discount*b.cart_num:b.price*b.cart_num});return a};GoodsApp.Goods=(function(){var a=function(){var b=GoodsApp.total_cart_goods_num();if(b>0){$(".btn-cart").html('<span class="glyphicon glyphicon-shopping-cart"></span> 我的购物车 <span class="badge">'+b+"</span>")}else{$(".btn-cart").html('<span class="glyphicon glyphicon-shopping-cart"></span> 我的购物车')}};return{init:function(){$(".body").html($("#GoodsTemplate").html());var b='<li class=""><a href="#tab${category_id}" role="tab" data-toggle="tab">${category_name}</a></li>';$.tmpl(b,category_data).appendTo(".app-topbar .nav");var b='<div class="tab-pane fade" id="tab${category_id}"><div class="row"></div></div>';$.tmpl(b,category_data).appendTo(".app-content .tab-content");$.each(goods_data,function(e,c){c.cart_num=c.cart_num||0;var d=$.tmpl($("#GoodsItemTemplate").html(),c);d.appendTo(".tab-content #tab"+c.category_id+" .row");$(".btn-add-shopping-cart",d).on("click",function(){c.cart_num=c.cart_num*1+1;$(this).html('<span class="glyphicon glyphicon-shopping-cart"></span> 购买 <span class="badge">'+c.cart_num+"</span>");a();return false});$(".thumbnail > a",d).on("click",function(){GoodsApp.GoodsDetail.render(c);return false})})},render:function(b){this.init();b=b||(window.location.hash!=""?window.location.hash:"#tab1");$('.app-topbar .nav a[href="'+b+'"]').tab("show");a();GoodsApp.ImageLazy.init();$(".app-topbar .nav a").on("shown.bs.tab",function(){GoodsApp.ImageLazy.loading()});$(".btn-cart").on("click",function(){GoodsApp.Cart.render();return false})}}})();GoodsApp.GoodsDetail=(function(){return{init:function(a){var b=$.tmpl($("#GoodsDetailTemplate").html(),a);$("img",$(b)).each(function(){$(this).attr("data-original",$(this).attr("src")).addClass("lazy").removeAttr("src")});$(".body").html(b)},render:function(b){var a=$(".app-topbar .nav li.active a").attr("href");this.init(b);GoodsApp.ImageLazy.init();$(".btn-back,.app-topbar a").on("click",function(){GoodsApp.Goods.render(a);return false})}}})();GoodsApp.Cart=(function(){var a=function(){$(".app-content .total-num").text(GoodsApp.total_cart_goods_num());$(".app-content .total-price").text(GoodsApp.total_cart_goods_price())};var b=function(e,c){c.cart_num=c.cart_num||0;if(!c.cart_num){return}var d=$.tmpl($("#CartGoodsTemplate").html(),c);d.appendTo(".app-content .cart-list");$(".btn-minus",d).on("click",function(){if(c.cart_num*1==0){return false}c.cart_num=c.cart_num*1-1;$(".cart-num",d).text(c.cart_num);a();return false});$(".btn-plus",d).on("click",function(){c.cart_num=c.cart_num*1+1;$(".cart-num",d).text(c.cart_num);a();return false})};return{init:function(){$(".body").html($("#CartTemplate").html());$.each(goods_data,b);a()},render:function(){var c=$(".app-topbar .nav li.active a").attr("href");this.init();$(".btn-back,.app-topbar a").on("click",function(){GoodsApp.Goods.render(c);return false});$(".btn-submit-cart").on("click",function(){var e=$(this);e.button("loading");var d=[];$.each(goods_data,function(g,f){if(!f.cart_num){return}d.push({goods_id:f.goods_id,goods_price:f.discount>0?f.discount:f.price,cart_num:f.cart_num})});$.post(site_url("goods/cart"),{cart:d},function(f){e.button("reset");if(f.error){GoodsApp.Dialog.show("提示",f.error);return false}GoodsApp.Consignee.render()},"json");return false})}}})();GoodsApp.Consignee=(function(){return{init:function(){consignee_data.amount=user_data.amount;$el=$.tmpl($("#ConsigneeTemplate").html(),consignee_data);$(".body").html($el)},render:function(){this.init();$(".btn-back,.app-topbar a").on("click",function(){GoodsApp.Cart.render();return false});$(".payment-model").on("click",function(){var a=$(this).val();if(a=="微信支付"){GoodsApp.Dialog.show("提示","微信支付尚未开通，敬请期待！");return false}if(a=="余额支付"){var b=0;$.each(goods_data,function(d,c){b+=c.discount>0?c.discount*c.cart_num:c.price*c.cart_num});if(!user_data.amount||user_data.amount*1<b*1){GoodsApp.Dialog.show("提示","账户余额不足！");return false}$(".user-amount strong",$(this).parent()).html(user_data.amount-b*1)}});$(".btn-submit-consignee").on("click",function(){var a=$(this);if($.trim($("#Consignee_username").val())==""){GoodsApp.Dialog.show("提示","请填写收货人的姓名！");return false}if($.trim($("#Consignee_mobile").val())==""){GoodsApp.Dialog.show("提示","请填写收货人的手机号！");return false}if($.trim($("#Consignee_address").val())==""){GoodsApp.Dialog.show("提示","请填写收货人的详细地址！");return false}a.button("loading");var b=$(".consignee-form").serialize();$.post(site_url("goods/order"),b,function(c){a.button("reset");if(c.error){GoodsApp.Dialog.show("提示",c.error);return false}GoodsApp.Order.render(c)},"json");return false})}}})();GoodsApp.Order=(function(){return{init:function(a){var b=$("#OrderTemplate").html();$(".body").html($.tmpl(b,{order_sn:a.order_sn||"-"}))},render:function(a){this.init(a);$(".app-topbar a").on("click",function(){window.location.reload();return false})}}})();GoodsApp.init();